name: Manual Builds

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Run Android build'
        type: boolean
        default: true
      build_ios:
        description: 'Run iOS build'
        type: boolean
        default: true
      build_windows:
        description: 'Run Windows desktop build'
        type: boolean
        default: false
      build_linux:
        description: 'Run Linux desktop build'
        type: boolean
        default: false
      build_macos:
        description: 'Reserved for macOS desktop build (signing not configured)'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  prepare_release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Read app version
        id: version
        run: |
          VERSION=$(node -e "const fs = require('fs'); const app = JSON.parse(fs.readFileSync('app.json', 'utf8')).expo || {}; const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); console.log(app.version || pkg.version);")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Ensure draft release exists
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          TAG="v${VERSION}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, reusing it."
          else
            gh release create "$TAG" --draft --title "$TAG" --notes "Automated build for $TAG"
          fi

  android:
    needs: prepare_release
    if: inputs.build_android == true
    runs-on: ubuntu-latest
    env:
      EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
      EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}
      EAS_NO_CREDENTIALS: 1
      RELEASE_TAG: ${{ needs.prepare_release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build Android AAB locally
        run: eas build --platform android --profile production --non-interactive --local --output=android-release.aab

      - name: Build Android APK locally
        run: eas build --platform android --profile production_apk --non-interactive --local --output=android-release.apk

      - name: Upload Android artifacts to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$RELEASE_TAG" "android-release.aab" "android-release.apk" --clobber

  ios:
    needs: prepare_release
    if: inputs.build_ios == true
    runs-on: macos-latest
    env:
      EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
      EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}
      EAS_NO_CREDENTIALS: 1
      RELEASE_TAG: ${{ needs.prepare_release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build iOS locally
        run: eas build --platform ios --profile production --non-interactive --local

      - name: Locate iOS artifact
        id: find_ios_artifact
        run: |
          find_latest() {
            python3 - "$@" <<'PY'
          import pathlib, sys

          root = pathlib.Path(sys.argv[1])
          exts = sys.argv[2:]
          paths = [p for ext in exts for p in root.rglob(f'*{ext}')]
          print(max(paths, key=lambda p: p.stat().st_mtime).resolve() if paths else "")
          PY
          }

          mkdir -p artifacts

          ARTIFACT=$(find_latest "." .ipa)

          if [ -z "$ARTIFACT" ]; then
            TAR=$(find_latest "." .tar.gz)
            if [ -n "$TAR" ]; then
              echo "Extracting $TAR to locate iOS artifact"
              TMPDIR=$(mktemp -d)
              tar -xzf "$TAR" -C "$TMPDIR"
              INNER=$(find_latest "$TMPDIR" .ipa)
              if [ -n "$INNER" ]; then
                DEST="artifacts/$(basename "$INNER")"
                cp "$INNER" "$DEST"
                ARTIFACT="$DEST"
              fi
            fi
          fi

          if [ -z "$ARTIFACT" ]; then
            echo "No iOS artifact found"
            exit 1
          fi
          echo "path=$ARTIFACT" >> "$GITHUB_OUTPUT"
          ls -lh "$ARTIFACT"

      - name: Upload iOS artifact to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$RELEASE_TAG" "${{ steps.find_ios_artifact.outputs.path }}" --clobber

  desktop_windows:
    needs: prepare_release
    if: inputs.build_windows == true
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ needs.prepare_release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build desktop Windows package
        run: npm run desktop:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

      - name: Upload Windows artifacts to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=(dist/*.exe dist/*.msi dist/*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No Windows artifacts found in dist/"
            exit 1
          fi
          gh release upload "$RELEASE_TAG" "${files[@]}" --clobber
        shell: bash

  desktop_linux:
    needs: prepare_release
    if: inputs.build_linux == true
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ needs.prepare_release.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build desktop Linux package
        run: npm run desktop:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=(dist/*.AppImage dist/*.deb dist/*.rpm dist/*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No Linux artifacts found in dist/"
            exit 1
          fi
          gh release upload "$RELEASE_TAG" "${files[@]}" --clobber
